var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};import{EventEmitter,Input,Output}from"@angular/core";import{convertToBoolean,isTypeof,removeDuplicatedOptions,validValue}from"../../../utils/util";import{requiredFailed}from"../validators";import{ThfComboFilterMode}from"./thf-combo-filter-mode.enum";var THF_COMBO_DEBOUNCE_TIME_DEFAULT=400,THF_COMBO_FIELD_LABEL_DEFAULT="label",THF_COMBO_FIELD_VALUE_DEFAULT="value",ThfComboBaseComponent=function(){function e(){this._changeOnEnter=!1,this._debounceTime=400,this._disabled=!1,this._disabledInitFilter=!1,this._fieldLabel="label",this._fieldValue="value",this._filterMinlength=0,this._filterMode=ThfComboFilterMode.startsWith,this._options=[],this._required=!1,this.cacheOptions=[],this.cacheStaticOptions=[],this.firstInWriteValue=!0,this.isFirstFilter=!0,this.isFiltering=!1,this.visibleOptions=[],this.placeholder="",this.sort=!1,this.change=new EventEmitter,this.ngModelChange=new EventEmitter}return Object.defineProperty(e.prototype,"filterService",{get:function(){return this._filterService},set:function(e){this._filterService=e,this.configAfterSetFilterService(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"debounceTime",{get:function(){return this._debounceTime},set:function(e){var t=parseInt(e,10);this._debounceTime=!isNaN(t)&&t>0?t:THF_COMBO_DEBOUNCE_TIME_DEFAULT,this.unsubscribeKeyupObservable(),this.initInputObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disabledInitFilter",{get:function(){return this._disabledInitFilter},set:function(e){this._disabledInitFilter=convertToBoolean(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldValue",{get:function(){return this._fieldValue},set:function(e){this._fieldValue=e||THF_COMBO_FIELD_VALUE_DEFAULT,isTypeof(this.filterService,"string")&&this.service&&(this.service.fieldValue=this._fieldValue)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldLabel",{get:function(){return this._fieldLabel},set:function(e){this._fieldLabel=e||THF_COMBO_FIELD_LABEL_DEFAULT,isTypeof(this.filterService,"string")&&this.service&&(this.service.fieldLabel=this._fieldLabel)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterMinlength",{get:function(){return this._filterMinlength},set:function(e){var t="string"==typeof e?parseInt(e,10):e;this._filterMinlength=Number.isInteger(t)?t:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"required",{get:function(){return this._required},set:function(e){this._required=convertToBoolean(e),this.validateModel(this.selectedValue)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changeOnEnter",{get:function(){return this._changeOnEnter},set:function(e){this._changeOnEnter=convertToBoolean(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disabled",{get:function(){return this._disabled},set:function(e){this._disabled=convertToBoolean(e),this.validateModel(this.selectedValue)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this._options},set:function(e){this._options=Array.isArray(e)?e:[],this.cacheStaticOptions=this.options,this.validAndSortOptions(),removeDuplicatedOptions(this.options),this.updateComboList()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"setSort",{set:function(e){this.sort=""===e||convertToBoolean(e),this.validAndSortOptions()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterMode",{get:function(){return this._filterMode},set:function(e){switch(this._filterMode=e in ThfComboFilterMode?e:ThfComboFilterMode.startsWith,this._filterMode.toString()){case"startsWith":this._filterMode=ThfComboFilterMode.startsWith;break;case"contains":this._filterMode=ThfComboFilterMode.contains;break;case"endsWith":this._filterMode=ThfComboFilterMode.endsWith}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterParams",{get:function(){return this._filterParams},set:function(e){this._filterParams=e||0===e||!1===e?e:void 0},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){this.updateComboList()},e.prototype.onInitService=function(){this.filterService&&(this.setService(this.filterService),this.initInputObservable())},e.prototype.setService=function(e){e&&(isTypeof(e,"object")?this.service=e:(this.service=this.defaultService,this.service.configProperties(e,this.fieldLabel,this.fieldValue)))},e.prototype.validAndSortOptions=function(){if(this.options&&this.options.length>0)for(var e=0;e<this.options.length;e++)validValue(this.options[e].value)?this.options[e].label||(this.options[e].label=this.options[e].value.toString()):this.options.splice(e,1);this.sortOptions()},e.prototype.sortOptions=function(){this.options&&this.options.length>0&&this.sort&&this.options.sort(this.compareOptions)},e.prototype.compareOptions=function(e,t){return e.label.toString().toLowerCase()<t.label.toString().toLowerCase()?-1:e.label.toString().toLowerCase()>t.label.toString().toLowerCase()?1:0},e.prototype.compareMethod=function(e,t,i){switch(i){case ThfComboFilterMode.startsWith:return this.startsWith(e,t);case ThfComboFilterMode.contains:return this.contains(e,t);case ThfComboFilterMode.endsWith:return this.endsWith(e,t)}},e.prototype.startsWith=function(e,t){return t.label.toLowerCase().startsWith(e.toLowerCase())},e.prototype.contains=function(e,t){return t.label.toLowerCase().indexOf(e.toLowerCase())>-1},e.prototype.endsWith=function(e,t){return t.label.toLowerCase().endsWith(e.toLowerCase())},e.prototype.getOptionFromValue=function(e,t){var i=this;return t?t.find(function(t){return i.isEqual(t.value,e)}):null},e.prototype.getOptionFromLabel=function(e,t){return t?t.find(function(t){return t.label.toString().toLowerCase()===e.toString().toLowerCase()}):null},e.prototype.updateSelectedValue=function(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!1);var o=e&&e.label||"";if(this.updateInternalVariables(e),this.changeOnEnter&&t?this.setInputValue(o):this.changeOnEnter||this.setInputValue(o),t){var n=e&&e.value||void 0;this.updateModel(n,i)}},e.prototype.callModelChange=function(e){return this.onModelChange?this.onModelChange(e):this.ngModelChange.emit(e)},e.prototype.isEqual=function(e,t){return(e||0===e)&&t?e.toString()===t.toString():((null===e&&null!==t||void 0===e&&void 0!==t)&&(e=""+e),e===t)},e.prototype.searchForLabel=function(e,t,i){var o=this;if(e&&t&&t.length){var n=[];t.forEach(function(t){t.label&&(o.compareMethod(e,t,i)||o.service)&&n.push(t)}),this.selectedView=n[0],this.updateComboList(n)}else this.updateComboList()},e.prototype.updateComboList=function(e){var t=e||this.options.slice(),i=!e&&this.selectedValue?[__assign({},this.selectedOption)]:t;i&&(this.visibleOptions=i,!this.selectedView&&this.visibleOptions.length&&(this.selectedView=this.visibleOptions[0]))},e.prototype.getNextOption=function(e,t,i){void 0===i&&(i=!1);var o=[].concat(t),n=null,r=!1;i&&o.reverse();for(var s=0;s<o.length;s++){var l=o[s];if(n||(n=l),r)return l;this.isEqual(l.value,e)&&(r=!0)}return n},e.prototype.getIndexSelectedView=function(){for(var e=0;e<this.visibleOptions.length;e++)if(this.compareObjects(this.visibleOptions[e],this.selectedView))return e;return null},e.prototype.compareObjects=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},e.prototype.verifyValidOption=function(){var e=this.getInputValue(),t=this.getOptionFromLabel(e,this.options);if(t&&t.value!==this.selectedValue)return this.updateSelectedValue(t),void(this.previousSearchValue=t.label);if(this.selectedValue&&this.selectedOption&&this.selectedOption.label!==e)return this.updateSelectedValueWithOldOption(),void(this.previousSearchValue=this.selectedOption.label);if(e&&!t){var i=!(!this.selectedOption||this.selectedOption.label===e);return this.updateSelectedValue(null,i||this.changeOnEnter),void(this.previousSearchValue="")}},e.prototype.writeValue=function(e){if(validValue(e)&&!this.service&&this.options&&this.options.length){var t=this.getOptionFromValue(e,this.options);return this.updateSelectedValue(t),void this.updateComboList()}if(e&&this.service)return this.getObjectByValue(e);validValue(e)||(this.updateSelectedValue(null,!0,!0),this.updateComboList())},e.prototype.registerOnChange=function(e){this.onModelChange=e},e.prototype.registerOnTouched=function(e){this.onModelTouched=e},e.prototype.registerOnValidatorChange=function(e){this.validatorChange=e},e.prototype.validate=function(e){if(requiredFailed(this.required,this.disabled,e.value))return{required:{valid:!1}}},e.prototype.validateModel=function(e){this.validatorChange&&this.validatorChange(e)},e.prototype.configAfterSetFilterService=function(e){e?(this.options=[],this.unsubscribeKeyupObservable(),this.onInitService()):(this.service=void 0,this.options=this.cacheStaticOptions),this.visibleOptions=[],this.isFirstFilter=!0},e.prototype.unsubscribeKeyupObservable=function(){this.keyupSubscribe&&this.keyupSubscribe.unsubscribe()},e.prototype.updateInternalVariables=function(e){e?(this.selectedView=e,this.selectedOption=e):(this.selectedView=void 0,this.selectedOption=void 0)},e.prototype.updateModel=function(e,t){void 0===t&&(t=!1),e!==this.selectedValue&&(t||this.callModelChange(e),this.change.emit(e)),this.selectedValue=e},e.prototype.updateSelectedValueWithOldOption=function(){var e=this.getOptionFromValue(this.selectedValue,this.options);if(e&&e.label)return this.updateSelectedValue(e)},e.propDecorators={label:[{type:Input,args:["t-label"]}],help:[{type:Input,args:["t-help"]}],placeholder:[{type:Input,args:["t-placeholder"]}],name:[{type:Input,args:["name"]}],filterService:[{type:Input,args:["t-filter-service"]}],debounceTime:[{type:Input,args:["t-debounce-time"]}],disabledInitFilter:[{type:Input,args:["t-disabled-init-filter"]}],fieldValue:[{type:Input,args:["t-field-value"]}],fieldLabel:[{type:Input,args:["t-field-label"]}],filterMinlength:[{type:Input,args:["t-filter-minlength"]}],required:[{type:Input,args:["t-required"]}],changeOnEnter:[{type:Input,args:["t-change-on-enter"]}],disabled:[{type:Input,args:["t-disabled"]}],options:[{type:Input,args:["t-options"]}],setSort:[{type:Input,args:["t-sort"]}],filterMode:[{type:Input,args:["t-filter-mode"]}],filterParams:[{type:Input,args:["t-filter-params"]}],change:[{type:Output,args:["t-change"]}],ngModelChange:[{type:Output,args:["ngModelChange"]}]},e}();export{ThfComboBaseComponent};