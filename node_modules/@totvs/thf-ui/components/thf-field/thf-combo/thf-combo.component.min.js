var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}).apply(this,arguments)};import{Component,ElementRef,forwardRef,IterableDiffers,Renderer2,ViewChild}from"@angular/core";import{DomSanitizer}from"@angular/platform-browser";import{NG_VALIDATORS,NG_VALUE_ACCESSOR}from"@angular/forms";import{fromEvent}from"rxjs";import{debounceTime,distinctUntilChanged,filter,map,tap}from"rxjs/operators";import{removeDuplicatedOptions}from"../../../utils/util";import{ThfComboBaseComponent}from"./thf-combo-base.component";import{ThfComboFilterMode}from"./thf-combo-filter-mode.enum";import{ThfComboFilterService}from"./thf-combo-filter.service";var ThfComboComponent=function(t){function e(e,i,o,s,n){var r=t.call(this)||this;return r.element=e,r.differs=i,r.defaultService=o,r.renderer=s,r.sanitized=n,r.comboIcon="thf-icon-arrow-down",r.comboOpen=!1,r.isProcessingGetObjectByValue=!1,r.isServerSearching=!1,r.scrollTop=0,r.shouldMarkLetters=!0,r.differ=i.find([]).create(null),r}return __extends(e,t),e.prototype.ngDoCheck=function(){this.differ.diff(this.options)&&(this.validAndSortOptions(),removeDuplicatedOptions(this.options))},e.prototype.ngOnDestroy=function(){this.filterSubscription&&this.filterSubscription.unsubscribe(),this.getSubscription&&this.getSubscription.unsubscribe()},e.prototype.onKeyDown=function(t){var e=t.target.value;if(this.service&&9===t.keyCode&&e)return this.controlComboVisibility(!1),this.getObjectByValue(e);if(38===t.keyCode||40===t.keyCode)return t.preventDefault(),this.comboOpen&&(38===t.keyCode?this.selectPreviousOption():this.selectNextOption()),this.controlComboVisibility(!0),this.isFiltering=!!this.changeOnEnter&&this.isFiltering,void(this.shouldMarkLetters=!!this.changeOnEnter&&this.shouldMarkLetters);if(9===t.keyCode||27===t.keyCode)return 27===t.keyCode&&this.comboOpen&&(t.preventDefault(),t.stopPropagation()),this.controlComboVisibility(!1),this.verifyValidOption(),void(this.service||(this.selectedView=this.changeOnEnter&&!this.selectedValue?void 0:this.selectedView,this.updateComboList()));if(13===t.keyCode&&this.selectedView&&this.comboOpen){var i=this.selectedView.value!==this.selectedValue||e!==this.selectedView.label;return this.controlComboVisibility(!1),this.updateSelectedValue(this.selectedView,i),this.isFiltering=!1,void this.updateComboList()}this.controlComboVisibility(!0)},e.prototype.onKeyUp=function(t){var e=t.keyCode||t.which,i=t.target.value;if(38!==e&&40!==e&&13!==e)if(i)this.service||this.previousSearchValue===i||(this.shouldMarkLetters=!0,this.isFiltering=!0,this.searchForLabel(i,this.options,this.filterMode));else{var o=this.service&&this.selectedValue&&this.selectedOption.label===this.previousSearchValue;this.updateSelectedValue(null),this.service?o&&this.updateComboList(this.cacheOptions.slice()):this.updateComboList(),this.isFiltering=!1}this.previousSearchValue=i},e.prototype.initInputObservable=function(){var t=this;if(this.service){var e=fromEvent(this.inputElement.nativeElement,"keyup").pipe(filter(function(e){return t.isValidCharacterToSearch(e.keyCode)}),map(function(t){return t.currentTarget.value}),distinctUntilChanged(),tap(function(){t.shouldMarkLetters=!1}),debounceTime(this.debounceTime));this.keyupSubscribe=e.subscribe(function(e){(e.length>=t.filterMinlength||!e)&&t.controlApplyFilter(e)})}},e.prototype.controlApplyFilter=function(t){this.isProcessingGetObjectByValue||this.selectedOption&&t===this.selectedOption.label||this.applyFilter(t)},e.prototype.applyFilter=function(t){var e=this;this.isServerSearching=!0,this.controlComboVisibility(!1);var i={property:this.fieldLabel,value:t};this.filterSubscription=this.service.getFilteredData(i,this.filterParams).subscribe(function(i){return e.setOptionsByApplyFilter(t,i)})},e.prototype.setOptionsByApplyFilter=function(t,e){this.shouldMarkLetters=!0,this.isServerSearching=!1,this.options=e,this.searchForLabel(t,e,this.filterMode),this.controlComboVisibility(!0),this.isFirstFilter&&(this.isFirstFilter=!this.isFirstFilter,this.cacheOptions=this.options)},e.prototype.getObjectByValue=function(t){var e=this;this.selectedValue||(this.isProcessingGetObjectByValue=!0,this.getSubscription=this.service.getObjectByValue(t,this.filterParams).subscribe(function(t){return e.updateOptionByFilteredValue(t)}))},e.prototype.updateOptionByFilteredValue=function(t){var e=this;t?(this.options=[t],this.onOptionClick(t)):this.updateSelectedValue(null),setTimeout(function(){e.isProcessingGetObjectByValue=!1},this.debounceTime)},e.prototype.selectPreviousOption=function(){var t=this.changeOnEnter?this.selectedView&&this.selectedView.value:this.selectedValue;if(t){var e=this.getNextOption(t,this.visibleOptions,!0);this.updateSelectedValue(e,e&&e.value!==t&&!this.changeOnEnter)}else if(this.visibleOptions.length){var i=this.visibleOptions[this.visibleOptions.length-1];this.updateSelectedValue(i,i.value!==t&&!this.changeOnEnter)}},e.prototype.selectNextOption=function(){var t=this.changeOnEnter?this.selectedView&&this.selectedView.value:this.selectedValue;if(t){var e=this.getNextOption(t,this.visibleOptions);this.updateSelectedValue(e,e&&e.value!==t&&!this.changeOnEnter)}else if(this.visibleOptions.length){var i=this.changeOnEnter?1:0,o=this.visibleOptions[i];this.updateSelectedValue(o,o.value!==t&&!this.changeOnEnter)}},e.prototype.toggleComboVisibility=function(){this.disabled||(this.service&&!this.disabledInitFilter&&this.applyFilterInFirstClick(),this.controlComboVisibility(!this.comboOpen))},e.prototype.applyFilterInFirstClick=function(){this.isFirstFilter&&!this.selectedValue&&this.applyFilter("")},e.prototype.controlComboVisibility=function(t){this.comboIcon=t?"thf-icon-arrow-up":"thf-icon-arrow-down",this.options&&this.options.length&&(t&&!this.selector(".thf-combo-content").classList.contains("thf-combo-show")?(this.selector(".thf-combo-content").classList.add("thf-combo-show"),this.initializeListeners()):!t&&this.selector(".thf-combo-content").classList.contains("thf-combo-show")&&(this.selector(".thf-combo-content").classList.remove("thf-combo-show"),this.removeListeners())),this.comboOpen=t,t?(this.inputElement.nativeElement.focus(),this.scrollTo(this.getIndexSelectedView())):this.isFiltering=!1},e.prototype.onOptionClick=function(t){var e=this.getInputValue(),i=t.value!==this.selectedValue||!(!this.selectedView||e===this.selectedView.label);this.updateSelectedValue(t,i),this.controlComboVisibility(!1),this.updateComboList([__assign({},this.selectedView)]),this.previousSearchValue=this.selectedView.label},e.prototype.scrollTo=function(t){this.scrollTop=t<=2?0:44*t-88},e.prototype.getInputValue=function(){return this.inputElement.nativeElement.value},e.prototype.setInputValue=function(t){this.inputElement.nativeElement.value=t},e.prototype.selector=function(t){return this.element.nativeElement.querySelector(t)},e.prototype.wasClickedOnToggle=function(t){this.inputElement.nativeElement.contains(t.target)||this.iconElement.nativeElement.contains(t.target)||this.contentElement.nativeElement.contains(t.target)||!this.comboOpen||(this.controlComboVisibility(!1),this.verifyValidOption(),this.selectedView=this.changeOnEnter&&!this.selectedValue?void 0:this.selectedView,this.updateComboList())},e.prototype.getLabelFormatted=function(t){var e=t;if(this.isFiltering||this.service&&this.getInputValue()&&!this.compareObjects(this.cacheOptions,this.visibleOptions)&&this.shouldMarkLetters){var i=this.getInputValue().toString().toLowerCase(),o=t.toLowerCase(),s='<span class="thf-font-text-large-bold">';switch(this.filterMode){case ThfComboFilterMode.startsWith:case ThfComboFilterMode.contains:e=t.substring(0,o.indexOf(i))+s+t.substring(o.indexOf(i),o.indexOf(i)+i.length)+"</span>"+t.substring(o.indexOf(i)+i.length);break;case ThfComboFilterMode.endsWith:e=t.substring(0,o.lastIndexOf(i))+s+t.substring(o.lastIndexOf(i))+"</span>"}}return this.safeHtml(e)},e.prototype.safeHtml=function(t){return this.sanitized.bypassSecurityTrustHtml(t)},e.prototype.isValidCharacterToSearch=function(t){return 9!==t&&13!==t&&16!==t&&17!==t&&18!==t&&20!==t&&27!==t&&37!==t&&38!==t&&39!==t&&40!==t&&93!==t},e.prototype.searchOnEnter=function(t){this.service&&!this.selectedView&&t.length>=this.filterMinlength&&this.controlApplyFilter(t)},e.prototype.initializeListeners=function(){var t=this;this.clickoutListener=this.renderer.listen("document","click",function(e){t.wasClickedOnToggle(e)})},e.prototype.removeListeners=function(){this.clickoutListener&&this.clickoutListener()},e.decorators=[{type:Component,args:[{selector:"thf-combo",template:'<thf-field-container [t-label]="label" [t-help]="help" [t-opcional]="!required"> <div class="thf-field-container-content"> <input #inputElement class="thf-input thf-combo-input" autocomplete="off" type="text" [attr.name]="name" [disabled]="disabled" [placeholder]="placeholder" [required]="required" (click)="toggleComboVisibility()" (keyup)="onKeyUp($event)" (keyup.enter)="searchOnEnter($event.target.value)" (keydown)="onKeyDown($event)"> <div class="thf-field-icon-container-right"> <span #icon class="thf-icon thf-field-icon {{ comboIcon }}" [class.thf-field-icon-disabled]="disabled" [class.thf-field-icon]="!disabled" (click)="toggleComboVisibility()"> </span> </div> <ul #contentElement class="thf-combo-content" [scrollTop]="scrollTop"> <li *ngFor="let option of visibleOptions" [value]="option.value" (click)="onOptionClick(option)" [class.thf-combo-item-selected]="compareObjects(selectedView, option)"> <a class="thf-combo-item" [innerHTML]="getLabelFormatted(option?.label)"></a> </li> </ul> <div class="thf-combo-content-loading" *ngIf="isServerSearching"> <thf-loading></thf-loading> </div> </div> <thf-field-container-bottom></thf-field-container-bottom> </thf-field-container> ',providers:[ThfComboFilterService,{provide:NG_VALUE_ACCESSOR,useExisting:forwardRef(function(){return e}),multi:!0},{provide:NG_VALIDATORS,useExisting:forwardRef(function(){return e}),multi:!0}]}]}],e.ctorParameters=function(){return[{type:ElementRef},{type:IterableDiffers},{type:ThfComboFilterService},{type:Renderer2},{type:DomSanitizer}]},e.propDecorators={contentElement:[{type:ViewChild,args:["contentElement",{read:ElementRef}]}],iconElement:[{type:ViewChild,args:["icon",{read:ElementRef}]}],inputElement:[{type:ViewChild,args:["inputElement",{read:ElementRef}]}]},e}(ThfComboBaseComponent);export{ThfComboComponent};