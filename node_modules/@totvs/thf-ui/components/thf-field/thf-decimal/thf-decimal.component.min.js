var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();import{Component,ElementRef,forwardRef,Input,ViewChild}from"@angular/core";import{NG_VALUE_ACCESSOR,NG_VALIDATORS}from"@angular/forms";import{convertToInt}from"../../../utils/util";import{ThfInputBaseComponent}from"../thf-input/thf-input-base.component";var THF_DECIMAL_DEFAULT_DECIMALS_LENGTH=2,THF_DECIMAL_DEFAULT_THOUSAND_MAXLENGTH=13,ThfDecimalComponent=function(t){function e(e){var n=t.call(this)||this;return n.el=e,n._decimalsLength=THF_DECIMAL_DEFAULT_DECIMALS_LENGTH,n._thousandMaxlength=THF_DECIMAL_DEFAULT_THOUSAND_MAXLENGTH,n.decimalSeparator=",",n.fireChange=!1,n.isKeyboardAndroid=!1,n.minusSign="-",n.oldDotsLength=null,n.thousandSeparator=".",n.regex={thousand:new RegExp("\\.","g"),decimal:new RegExp("\\,","g")},n.isKeyboardAndroid=!!navigator.userAgent.match(/Android/i),n}return __extends(e,t),Object.defineProperty(e.prototype,"decimalsLength",{get:function(){return this._decimalsLength},set:function(t){this._decimalsLength=convertToInt(t,THF_DECIMAL_DEFAULT_DECIMALS_LENGTH)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"thousandMaxlength",{get:function(){return this._thousandMaxlength},set:function(t){var e=convertToInt(t,THF_DECIMAL_DEFAULT_THOUSAND_MAXLENGTH);this._thousandMaxlength=e<=THF_DECIMAL_DEFAULT_THOUSAND_MAXLENGTH?e:THF_DECIMAL_DEFAULT_THOUSAND_MAXLENGTH},enumerable:!0,configurable:!0}),e.prototype.ngAfterViewInit=function(){this.putFocus(),this.setPaddingInput()},e.prototype.clear=function(t){this.callOnChange(t),this.controlChangeEmitter()},e.prototype.extraValidation=function(t){return null},e.prototype.getScreenValue=function(){return this.inputEl?this.inputEl.nativeElement.value:""},e.prototype.hasInvalidClass=function(){return this.el.nativeElement.classList.contains("ng-invalid")&&this.el.nativeElement.classList.contains("ng-dirty")&&""!==this.getScreenValue()},e.prototype.hasLetters=function(t){return void 0===t&&(t=""),t.match(/[a-zA-Z:;+=_´^~"'@#$%¨&*()\/\\|]+/)},e.prototype.isValidNumber=function(t){var e=String.fromCharCode(t.which),n=8!==t.which&&0!==t.which;return!this.hasLetters(e)&&n},e.prototype.onBlur=function(t){var e=t.target.value;if(e){if(this.hasLetters(e)||this.containsMoreThanOneComma(e))return this.setViewValue(""),void this.callOnChange(void 0);var n=this.formatValueWithoutThousandSeparator(e);this.setViewValue(this.formatToViewValue(n))}this.blur.emit(),this.controlChangeEmitter()},e.prototype.onFocus=function(t){this.valueBeforeChange=this.getScreenValue(),this.enter.emit()},e.prototype.onInput=function(t){var e,n,i=t.target.selectionStart,r=t.target.selectionEnd;this.isKeyboardAndroid&&this.onInputKeyboardAndroid(t),e=this.formatValueWithoutThousandSeparator(t.target.value),e=this.addZeroBefore(e),n=this.formatMask(e),this.setViewValue(n),this.setCursorInput(t,i,r),this.callOnChange(this.formatToModelValue(e))},e.prototype.onInputKeyboardAndroid=function(t){var e=t.target.value,n=t.target.selectionStart,i=this.hasLetters(e);if(i)return this.setViewValue(e.replace(i[0],"")),t.preventDefault();var r=n-1,o=e.charAt(r);this.setPositionValue(t),this.isValidKey(t,o)&&this.setViewValue(e)},e.prototype.onKeyPress=function(t){this.isValidKey(t)},e.prototype.setPaddingInput=function(){var t=this;setTimeout(function(){var e=t.el.nativeElement.querySelectorAll(".thf-field-icon-container:not(.thf-field-icon-container-left) > .thf-icon").length;t.clean&&e++,e&&(t.inputEl.nativeElement.style.paddingRight=36*e+"px")})},e.prototype.writeValueModel=function(t){if(this.inputEl)if(t||0===t){var e=this.formatToViewValue(t);this.setViewValue(e)}else this.setViewValue("");t&&this.change.emit(t)},e.prototype.addZeroBefore=function(t){return t===this.decimalSeparator?"0"+t:t},e.prototype.containsComma=function(t){return t.includes(this.decimalSeparator)},e.prototype.containsMoreThanOneComma=function(t){void 0===t&&(t="");var e=t.match(/,/g);return!!(e&&e.length>1)},e.prototype.controlChangeEmitter=function(){var t=this,e=this.getScreenValue();e!==this.valueBeforeChange&&(this.fireChange=!0,setTimeout(function(){t.fireChange&&t.change.emit(e)},200))},e.prototype.formatMask=function(t){if(t.match(this.regex.decimal)){var e=new RegExp("(\\d)(?=(\\d{3})+(?!\\d),)","g");return t.toString().replace(e,"$1.")}return t.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1.")},e.prototype.formatToModelValue=function(t){var e=this.replaceCommaToDot(t),n=e?parseFloat(Number(e).toFixed(this.decimalsLength)):void 0;return 0===n||n?n:void 0},e.prototype.formatToViewValue=function(t){var e,n,i,r;return t=this.replaceCommaToDot(t),n=Number(t).toFixed(this.decimalsLength),i=this.getValueBeforeSeparator(n,this.thousandSeparator),r=this.getValueAfterSeparator(n,this.thousandSeparator),e=this.formatMask(i),0===this.decimalsLength?e:e+this.decimalSeparator+r},e.prototype.formatValueWithoutThousandSeparator=function(t){return void 0===t&&(t=""),t.toString().replace(this.regex.thousand,"")},e.prototype.getValueAfterSeparator=function(t,e){return void 0===t&&(t=""),t.split(e)[1]||""},e.prototype.getValueBeforeSeparator=function(t,e){return void 0===t&&(t=""),t.split(e)[0]||""},e.prototype.hasLessDot=function(t){if(t){var e=t.match(this.regex.thousand),n=e&&e.length;if(n<this.oldDotsLength)return this.oldDotsLength=n,!0}return t||(this.oldDotsLength=null),!1},e.prototype.hasMoreDot=function(t){if(t){var e=t.match(this.regex.thousand),n=e&&e.length;if(n>this.oldDotsLength)return this.oldDotsLength=n,!0}return t||(this.oldDotsLength=null),!1},e.prototype.hasMinusSignInvalidPosition=function(t){var e=t.key===this.minusSign,n=t.target.selectionStart;return e&&0!==n},e.prototype.isInvalidKey=function(t,e){var n=!this.isValidNumber(t);return this.verifyInsertComma(t)||this.verifyThousandLength(t)||this.verifyValueAfterComma(t)||this.verifyInsertMinusSign(t)||this.hasMinusSignInvalidPosition(t)||n||this.validateCursorPositionBeforeSeparator(t)||this.verifyDecimalLengthIsZeroAndKeyPressedIsComma(e)},e.prototype.isKeyDecimalSeparator=function(t){return t.key===this.decimalSeparator||t.char===this.decimalSeparator},e.prototype.isPositionAfterDecimalSeparator=function(t,e){var n=e&&e.indexOf(this.decimalSeparator);if(n&&this.decimalsLength>0)return t>n},e.prototype.isSelectionStartDifferentSelectionEnd=function(t){return t.selectionStart!==t.selectionEnd},e.prototype.isValidKey=function(t,e){var n=t.which||t.keyCode;if(!(8===t.which||0===t.which)||this.isKeyboardAndroid)return e&&(t.key=e),!this.isInvalidKey(t,n)||(t.preventDefault(),!1)},e.prototype.verifyDecimalLengthIsZeroAndKeyPressedIsComma=function(t){return 44===t&&0===this.decimalsLength},e.prototype.putFocus=function(){this.focus&&this.inputEl.nativeElement.focus()},e.prototype.setInitialSelectionRange=function(t,e,n){return 1===e&&1===n?t.setSelectionRange(e+1,n+1):t.setSelectionRange(e-1,n-1)},e.prototype.replaceAt=function(t,e,n){return t.substring(0,e)+n+t.substring(e+1)},e.prototype.replaceCommaToDot=function(t){return void 0===t&&(t=""),t.toString().replace(this.regex.decimal,".")},e.prototype.setCursorInput=function(t,e,n){var i=t.target,r=i.value;return this.hasMoreDot(r)||r==="0"+this.decimalSeparator?i.setSelectionRange(e+1,n+1):(this.hasLessDot(r)&&this.setInitialSelectionRange(i,e,n),i.setSelectionRange(e,n))},e.prototype.setPositionValue=function(t){var e=t.target.value,n=t.target.selectionStart-1;n>0&&t.key===this.minusSign&&(t.target.value=e.substring(0,n)+e.substr(n+1))},e.prototype.setViewValue=function(t){this.inputEl.nativeElement.value=t},e.prototype.validateCursorPositionBeforeSeparator=function(t){var e=t.target,n=this.formatValueWithoutThousandSeparator(e.value),i=this.getValueBeforeSeparator(e.value,this.decimalSeparator),r=this.getValueBeforeSeparator(n,this.decimalSeparator);return!this.isSelectionStartDifferentSelectionEnd(e)&&(e.selectionStart<=i.length&&r.length===this.thousandMaxlength&&!this.isKeyDecimalSeparator(t))},e.prototype.verifyThousandLength=function(t){var e=t.target,n=this.formatValueWithoutThousandSeparator(e.value),i=this.getValueBeforeSeparator(n,this.decimalSeparator);return!this.isSelectionStartDifferentSelectionEnd(e)&&(i.length>=this.thousandMaxlength&&!this.isKeyDecimalSeparator(t)&&this.isPositionAfterDecimalSeparator(e.selectionStart-this.decimalsLength,e.value))},e.prototype.verifyInsertComma=function(t){return this.containsComma(t.target.value)&&t.key===this.decimalSeparator},e.prototype.verifyInsertMinusSign=function(t){var e=t.target.value,n=-1!==e.lastIndexOf(this.minusSign),i=e.lastIndexOf("-"),r=e.match(new RegExp("-","g"));return this.isKeyboardAndroid&&n&&r.length>1&&(t.target.value=this.replaceAt(e,i,"")),n&&t.key===this.minusSign},e.prototype.verifyValueAfterComma=function(t){var e=t.target.value,n=t.target.selectionStart,i=this.getValueAfterSeparator(e,this.decimalSeparator);return this.isPositionAfterDecimalSeparator(n,e)&&i.length>=this.decimalsLength},e.decorators=[{type:Component,args:[{selector:"thf-decimal",template:'<thf-field-container [t-label]="label" [t-help]="help" [t-opcional]="!required"> <div class="thf-field-container-content"> <div *ngIf="icon" class="thf-field-icon-container-left"> <span class="thf-icon thf-field-icon {{ icon }}" [class.thf-field-icon-disabled]="disabled"></span> </div> <input #inp class="thf-input" type="text" (input)="onInput($event)" (focus)="onFocus($event)" (blur)="onBlur($event)" (keypress)="onKeyPress($event)" [attr.name]="name" [class.thf-input-icon-left]="icon" [class.thf-input-icon-right]="clean" [disabled]="disabled" [placeholder]="placeholder" [readonly]="readonly" [required]="required"> <div class="thf-field-icon-container-right"> <thf-clean [t-element-ref]="inputEl" (t-change-event)="clear($event)"></thf-clean> </div> </div> <thf-field-container-bottom> </thf-field-container-bottom> </thf-field-container> ',providers:[{provide:NG_VALUE_ACCESSOR,useExisting:forwardRef(function(){return e}),multi:!0},{provide:NG_VALIDATORS,useExisting:forwardRef(function(){return e}),multi:!0}]}]}],e.ctorParameters=function(){return[{type:ElementRef}]},e.propDecorators={inputEl:[{type:ViewChild,args:["inp",{read:ElementRef}]}],decimalsLength:[{type:Input,args:["t-decimals-length"]}],thousandMaxlength:[{type:Input,args:["t-thousand-maxlength"]}]},e}(ThfInputBaseComponent);export{ThfDecimalComponent};