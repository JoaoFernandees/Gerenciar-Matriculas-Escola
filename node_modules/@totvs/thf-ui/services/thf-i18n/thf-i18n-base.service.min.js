import{Inject}from"@angular/core";import{HttpClient}from"@angular/common/http";import{Observable}from"rxjs";import{I18N_CONFIG}from"./thf-i18n-config-injection-token";var ThfI18nBaseService=function(){function t(t,e){this.config=t,this.http=e,this.varI18n={},this.useCache=!1,this.servicesContext={},this.setConfig(t)}return t.prototype.setConfig=function(t){if(t.default&&(t.default.language?this.languageDefault=t.default.language.toLowerCase():this.languageDefault=navigator.language.toLowerCase(),this.contextDefault=t.default.context?t.default.context:"",this.useCache=!!t.default.cache&&t.default.cache),t.contexts&&(this.setVarI18n(t.contexts),!this.contextDefault))for(var e in t.contexts)if(this.config.contexts.hasOwnProperty(e)){this.contextDefault=e;break}},t.prototype.getLiterals=function(t){var e=this;void 0===t&&(t={});var r=t.language?t.language.toLowerCase():this.languageDefault.toLowerCase(),n=t.context?t.context:this.contextDefault,a=t.literals?t.literals:[];return new Observable(function(t){e.servicesContext[n]?e.getLiteralsFromContextService(r,n,a,t):e.getLiteralsFromContextConstant(r,n,a,t)})},t.prototype.getLiteralsFromContextService=function(t,e,r,n,a,o){void 0===a&&(a={}),void 0===o&&(o=null);var i=o||t;a=this.mergeObject(a,this.searchInVarI18n(i,e,r)),this.countObject(a)>0&&n.next(a),r.length>0?r.length>this.countObject(a)&&this.getLiteralsLocalStorageAndCache(i,e,r,n,a,o):this.getLiteralsLocalStorageAndCache(i,e,r,n,a,o)},t.prototype.getLiteralsLocalStorageAndCache=function(t,e,r,n,a,o){var i=this;void 0===o&&(o=null);var s,c=o||t;this.useCache&&(s=this.searchInLocalStorage(c,e,r),this.countObject(s)>0&&(this.updateVarI18n(t,e,s),a=this.mergeObject(a,s),n.next(a))),this.getHttpService(this.servicesContext[e],c,r).subscribe(function(c){c&&(i.updateLocalStorage(t,e,c),i.updateVarI18n(t,e,c),s=i.searchInVarI18n(t,e,r),a=i.mergeObject(a,s),n.next(a)),r.length>i.countObject(a)&&("pt-br"===o?(a=i.completeFaultLiterals(t,e,r,a),i.updateLocalStorage(t,e,a),i.updateVarI18n(t,e,a),n.next(a)):i.getLiteralsFromContextService(t,e,r,n,a,"pt-br"))})},t.prototype.getLiteralsFromContextConstant=function(t,e,r,n,a){void 0===a&&(a={}),a=this.mergeObject(a,this.searchInVarI18n(t,e,r)),this.countObject(a)>0&&n.next(a),r.length>0?r.length>this.countObject(a)&&("pt-br"===t?(a=this.completeFaultLiterals(t,e,r,a),n.next(a)):this.getLiteralsFromContextConstant("pt-br",e,r,n,a)):(0===this.countObject(a)&&"pt-br"!==t&&this.getLiteralsFromContextConstant("pt-br",e,r,n,a),n.next(a),n.complete())},t.prototype.searchInLocalStorage=function(t,e,r){var n={};if(r.length>0)for(var a=0;a<r.length;a++){var o=r[a],i=localStorage.getItem(t+"-"+e+"-"+o);i&&(n[o]=i)}return n},t.prototype.searchInVarI18n=function(t,e,r){var n={};if(this.varI18n[t]&&this.varI18n[t][e]){var a=this.varI18n[t][e];if(r.length>0)for(var o=0;o<r.length;o++){var i=r[o];a.hasOwnProperty(i)&&(n[i]=a[i])}else n=a}return n},t.prototype.updateLocalStorage=function(t,e,r){if(this.useCache)for(var n in r)r.hasOwnProperty(n)&&localStorage.setItem(t+"-"+e+"-"+n,r[n])},t.prototype.setVarI18n=function(t){for(var e in t)if(t.hasOwnProperty(e)){var r=t[e];for(var n in r)if(r.hasOwnProperty(n)){var a=r[n];"url"===n?this.servicesContext[e]=a:this.updateVarI18n(n,e,a)}}},t.prototype.updateVarI18n=function(t,e,r){var n;t=t.toLowerCase(),this.varI18n[t]||(this.varI18n[t]=((n={})[e]={},n)),this.varI18n[t][e]||(this.varI18n[t][e]={}),this.varI18n[t][e]=this.mergeObject(r,this.varI18n[t][e])},t.prototype.getHttpService=function(t,e,r){var n="?language="+e;return r.length>0&&(n+="&literals="+r.join()),t=t.lastIndexOf("/")===t.length-1?t.substr(0,t.length-1):t,this.http.get(t+n)},t.prototype.completeFaultLiterals=function(t,e,r,n){for(var a=0;a<r.length;a++){var o=r[a];n[o]||(n[o]=o)}return n},t.prototype.countObject=function(t){return Object.keys(t).length},t.prototype.mergeObject=function(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e},t.ctorParameters=function(){return[{type:void 0,decorators:[{type:Inject,args:[I18N_CONFIG]}]},{type:HttpClient,decorators:[{type:Inject,args:[HttpClient]}]}]},t}();export{ThfI18nBaseService};